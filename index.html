<!DOCTYPE html>
<html>
<head></head>
<body>    

<h1>Generate white noise</h1>
<ol type="A">
	<li>Click on filter_noise to play white noise.</li>
</ol>

<!-- Straight slider -->
<input type="range" id="slider_amplitude" name="slider_amplitude" value="0" min="1" max="10" step="1" /><label for="slider_amplitude">noise amplitude: <div id="slider_amplitude_value" style="display:block; text-align: left; width: 600px;"></div></label>

<!--Circular slider [2.4, 4.2]-->
<input type="range" class="circular" id="slider_frequency" name="slider_frequency" value="0" min="2.4" max="4.2" step="0.1" /><label for="slider_frequency">noise frequency: <div id="slider_frequency_value" style="display:block; text-align: left; width: 600px;"></div></label>

<!--Counter-->
<input id="counter_value" value="0" min="0" max="10000" step="1" />
<div id="counter_display" style="display:block; text-align: left; width: 600px;"></div>
	
<button id="play_filter_noise" onclick="play_filter_noise()" style="display:block">play_filter_noise</button>


<!-- ----------------------------------------------- -->

<style>

input#slider_amplitude { accent-color: green; }

input#slider_frequency { accent-color: blue; }
	
.circular { 
	/* transform-origin: 50% 50%; */
	border-radius: 50%;
}
	
</style>

<!-- ----------------------------------------------- -->
  
<script>

// -----------------------------------------------

async function processEvent_text_input(event) {

	if (document.getElementById("counter_value").value < 10) {
		await play_filter_noise()
	} 
	
}
	
document.getElementById("counter_value").addEventListener("change", processEvent_text_input, false);

// -----------------------------------------------

async function play_filter_noise() {

	const audioElement = await create_an_audioElement();

	const audioContext = new AudioContext();
	// default audioContext.sampleRate is 48000, a common value is 44100

	var sourceElement = audioContext.createBufferSource(audioElement);

	// -------------------
	
	const WhiteNoise_AudioBuffer = await create_audio_data(audioContext);
	// WhiteNoise_AudioBuffer:  AudioBuffer { sampleRate: 48000, length: 96000, duration: 2, numberOfChannels: 2 }
	
	sourceElement.buffer = WhiteNoise_AudioBuffer;
	sourceElement.id = "sourceElement_id";			
	sourceElement.connect(audioContext.destination);
	sourceElement.start(0);

	// -------------------

	// Update event
	document.getElementById("counter_value").value = document.getElementById("counter_value").value + 1;
	document.getElementById("counter_display").textContent = document.getElementById("counter_value").value;
	
	// -------------------
	
}






	
	

// -----------------------------------------------
// SUBFUNCTIONS
// -----------------------------------------------
	
async function create_an_audioElement() {

	// Create an AudioElement
	const audioElement = document.createElement('audio');
	// OR
	// const audioElement = new Audio();
	
	audioElement.setAttribute("controls", true);
	audioElement.setAttribute('crossOrigin', "anonymous"); // OR "anonymous"
	audioElement.setAttribute('autoplay', true);
	audioElement.setAttribute('preload', "auto");

	// https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/volume
	audioElement.volume = 0.1; 

	return audioElement;
}

// ----------------------------------------------------

async function create_audio_data(audioContext) {
	
	// Transform audiodata into correct format for source.buffer
	// https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createBufferSource
	const duration_seconds = 2;
	
	// -------------------

	const A = document.getElementById("slider_amplitude").value;
	document.getElementById("slider_amplitude_value").textContent = A;
	
	const A_max = document.getElementById("slider_amplitude").max;
	
	const k = document.getElementById("slider_frequency").value;  // wave number [0, 2*Math.PI]
	document.getElementById("slider_frequency_value").textContent = k;

	// -------------------

	const max_noise = 0.1;
	const A_max_noise_compensator = 1 - max_noise;
	const method = 'ampl_freq';

	// -------------------
	
	// Create an arrayBuffer
	const channels = 2; 
	const frameCount = audioContext.sampleRate * duration_seconds; // sample_length
	const sampleRate = audioContext.sampleRate; // sample_rate
	const WhiteNoise_AudioBuffer = audioContext.createBuffer(channels, frameCount, sampleRate);
	WhiteNoise_AudioBuffer.contentType = 'audio/mp3';
	
	for (let channel=0; channel<channels; channel++) {
		
		// Fill the buffer with audio data per channel
		const channelData_AudioBuffer = WhiteNoise_AudioBuffer.getChannelData(channel);
		
		// One knows the length of channelData_test because of the designated sample_length and sample_rate
		// frameCount OR channelData_AudioBuffer.length
		for (let i = 0; i < channelData_AudioBuffer.length; i++) {
			if (method == 'ampl_only') {
				// Way 0: amplitude modulation only
				// Math.random() generates a number from 0 and less than 1.
				var random_val_from_0_to_A = Math.random() * A; // a random value [0, A]
				channelData_AudioBuffer[i] = (random_val_from_0_to_A/A_max) * 2 - 1; // value from [-1, 1]
				
			} else if (method == 'ampl_freq') {
				// Way 1: amplitude frequency modulation
				var noise = Math.random() * A; // a random value [0, A]
				var noise_normalized = max_noise * (noise/A_max); // a random value [0, max_noise]
				channelData_AudioBuffer[i] = A_max_noise_compensator*(Math.sin(k*i)) + noise_normalized;
			}
			
		}
	}
	// console.log('WhiteNoise_AudioBuffer: ', WhiteNoise_AudioBuffer);

	// -------------------
	
	return WhiteNoise_AudioBuffer;
}
	
// -----------------------------------------------

</script>
</body>
</html>
